name: Build WP plugin unit-test container

on:
  push:
    tags:
      - test_workflow*

jobs:
  # To push the release (sources) to the WordPress.org SVN instance for this plugin
  build-containers:
    name: Build the plugin unit-test container for ${{ github.repository }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php: [ '7.4', '8.0' ]
    steps:
      # All steps after this one will have env variable `E20R_PLUGIN_NAME` passed to them.
      - run: echo E20R_PLUGIN_NAME=$(echo ${{ github.repository }} | awk -F / '{print $2}') >> $GITHUB_ENV
      - uses: nanasess/setup-php@master
        with:
          php-version: ${{ matrix.php }}
      - name: Install build deps for the ${{ env.E20R_PLUGIN_NAME }} unit-test container
        run: |
          make docker-compose-deps
          make php-composer

#      - uses: actions/checkout@v2
#        with:
#          repository: eighty20results/${{ env.E20R_PLUGIN_NAME }}
#          ssh_key: ${{ env.E20R_SSH_KEY }}
##          ref: test_workflow_updates
#          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull the container from the Docker HUB
        run: make image-pull
        shell: bash
        env:
          E20R_PLUGIN_NAME: ${{ env.E20R_PLUGIN_NAME }}

      - name: Update the container (build if necessary)
        run: make image-build
        shell: bash
        env:
          E20R_PLUGIN_NAME: ${{ env.E20R_PLUGIN_NAME }}
