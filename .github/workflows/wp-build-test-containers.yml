name: Build WP plugin unit-test container

on:
  push:
    tags:
      - test_workflow*

jobs:
  # To push the release (sources) to the WordPress.org SVN instance for this plugin
  build-containers:
    name: Build the plugin unit-test container for ${{ github.repository }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php: [ '7.3', '7.4', '8.0' ]
    steps:
      # All steps after this one will have env variable `E20R_PLUGIN_NAME` passed to them.
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.GITHUB }}
#          repository: eighty20results/${{ env.E20R_PLUGIN_NAME }}
#          ssh_key: ${{ env.E20R_SSH_KEY }}
#          ref: test_workflow_updates
#          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure the plugin name (from the repository name)
        run: echo E20R_PLUGIN_NAME=$(echo ${{ github.repository }} | awk -F / '{print $2}') >> $GITHUB_ENV

      - name: Install the bc utility - needed in order to install/configure php
        run: sudo apt-get update -y && sudo apt-get install -y bc

      - name: Install required PHP versions & tools
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: mbstring
          tools: composer:v2, phpunit, pecl, php-cs-fixer, phpcs, phplint, phpmd, phpstan
          coverage: pcov

      - name: Pull the container from the Docker HUB
        run: ls -l && make image-pull
        env:
          E20R_PLUGIN_NAME: ${{ env.E20R_PLUGIN_NAME }}

      - name: Update the container (build if necessary)
        run: make image-build
        env:
          E20R_PLUGIN_NAME: ${{ env.E20R_PLUGIN_NAME }}
